# 3天挑战架构师级MYSQL海量数据设计与实践

## 第一天

今天课程主要讲解的是mysql的数据是怎么存储的，内部结构是怎么样子的，如何使用一些数据结构上的算法进行查询的优化

### MYSQL存储引擎原理才拆解及设计深度刨析

##### mysql记录存储

page = 16KB

header = 56B

tailer = 8B

+ 页头

+ 虚记录
  + 比页内最大主键还大
  + 比页内最小主键还小

+ 记录堆

+ 自由空间链表：已删除空间的链表

+ 页内记录维护
  + 物理有序
  + **逻辑有序**

+ 插入策略
  + **自由空间链表**
  + 未使用空间

+ 页内查询
  + 遍历
  + 二分查找

##### mysql InnoDB存储引擎内存管理

+ 预分配内存空间
  + 先向操作系统申请一块很大的内存池（缓存空间）

+ 数据加载单元
  + 以一个Page16KB为加载单位
  + 内存页面管理Page hash表
    + 页面映射
    + 页面数据管理

+ 数据内外存交换
  + 内存满了，又要加载新的Page，可以把旧的flush刷入回磁盘中，腾出空间
  +  页面数据淘汰
    + LRU页面淘汰算法

##### mysql事务实现原理

+ MVCC
  + 多版本并发冲突
+ undo log
+ redo log

##### mysql锁实现原理

+ 粒度
  + 行级锁
  + 间隙锁
  + 表级锁
+ 类型
  + 共享锁
  + 排他锁



## 第二天

今天讲的是分表分库，将数据进行分开减少资源压力，随之带来的问题就是索引可能会出现问题，本课解决在分表的时候索引有效性的问题

### 海量数据高并发场景主键设计选择

##### 索引原理分析

+ 聚簇索引（主键索引）
  + 数据存储在主键索引中（数据和索引存一起）
  + 数据按主键顺序存储
+ 二级索引
  + 除主键索引以外的索引
  + 叶子中存储主键索引值
  + 一次查询需要走两遍索引
  + 主键索引值大小会影响二级索引的B+树大小
+ 联合索引（联合索引可以是主键索引也可以是二级索引）
  + key由多个字段组合
  + 最左匹配原则
  + 一个索引只创建一棵B+树
  + 比较规则：按第一列排序，第一列相同按第二列排序
  + 注：
    + 如果不是按照最左开始查找，无法使用索引
    + 不能跳过中间列
    + 某列使用范围查找，后面的列不能使用索引

##### 索引使用优化分析

+ 存储空间
  + 索引文件大小
  + 字段大小->page页内节点个数->树的层数
+ 主键选择
  + 自增主键，顺序写入，效率高，存在安全问题，分表分库时不宜维护
  + 随机主键，结点分裂，数据移动
  + **业务主键：雪花算法，写入、查询磁盘利用率都高，可以使用一级索引**
  + 联合主键：影响索引大小，不易维护，不建议使用
+ 联合索引使用
  + 按索引区分度优先排序
  + 覆盖索引，例如：一个联合索引（二级索引）中的第一列作为条件查第二列的值，这样就不需要回表（主键索引B+树）
  + 索引下推
+ 字符串索引
  + 设计合理长度
  + 不支持%开头的模糊查询

##### 索引失效问题分析

+ A = xxx or B = xxx
+ 隐式类型转换
+ 索引列包含计算
+ 数据范围影响
  + 索引区分度过低
  + 条件超出索引范围：例如，数据库中的



+ 联合索引：优于多列



## 第三天



### 分布式事务阿里巴巴Seata应用设计实践



































